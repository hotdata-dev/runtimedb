name: Build PR Image

on:
  issue_comment:
    types: [created]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-C debuginfo=0"
  RUSTC_WRAPPER: sccache

jobs:
  build:
    name: Build (${{ matrix.arch }})
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/build')
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
      pull-requests: write
    steps:
      - name: Get PR branch
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const branch = pr.data.head.ref;
            // sanitize branch name for docker tag (replace non-alphanumeric with -)
            const tag = branch.replace(/[^a-zA-Z0-9._-]/g, '-');
            core.setOutput('ref', pr.data.head.sha);
            core.setOutput('branch', branch);
            core.setOutput('tag', tag);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: Free disk space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/.ghcup

      - uses: mozilla-actions/sccache-action@v0.0.5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache: false

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-

      - name: Build release binary
        run: cargo build --release --bin server

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }}-${{ matrix.arch }} .
          docker push ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }}-${{ matrix.arch }}

  manifest:
    name: Create multi-arch manifest
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      packages: write
      pull-requests: write
    steps:
      - name: Get PR branch
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const branch = pr.data.head.ref;
            const tag = branch.replace(/[^a-zA-Z0-9._-]/g, '-');
            core.setOutput('tag', tag);

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          docker manifest create ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }} \
            ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }}-amd64 \
            ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }}-arm64
          docker manifest push ghcr.io/${{ github.repository }}:${{ steps.pr.outputs.tag }}

      - name: Comment image info on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.pr.outputs.tag }}';
            const repo = '${{ github.repository }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üê≥ Docker image built and pushed:\n\`\`\`\nghcr.io/${repo}:${tag}\n\`\`\``
            });
